"use strict";angular.module("drumbeats",["firebaseHelper"]).config(["$firebaseHelperProvider",function(e){e.namespace("mismith"),e.root("drumbeats")}]).controller("AppCtrl",["$rootScope",function(e){e.console=console}]).controller("BeatCtrl",["$scope","$rootScope","$firebaseHelper","$timeout",function(e,t,n){e.channels=n.array("channels"),e.beats=n.object("beats"),e.selectedBeat=0,e.beats.$loaded().then(function(){e.beats.forEach(function(t,n){e.selectedBeat||(e.selectedBeat=n)}),e.$watch("selectedBeat",function(t){e.beat=e.beats[t]||{}}),e.$watchCollection("beat",function(){e.guides=i(e.beat)})});var r=function(e){return e?e.beatsPerBar*e.barsPerLine:0},a=function(e){return e&&e.beatsPerBar?e.beatsPerBar%4==0?.25:e.beatsPerBar%3==0?1/3:.5:0},i=function(e){if(!e)return[];for(var t=[],n=a(e),r=0;r<e.barsPerLine/a(e)*e.beatsPerBar;r++){var i=r*n+1;t.push(i)}return t},s=function(e){if(!e||!e.channels)return 0;var t=0;angular.forEach(e.channels,function(e){t=Math.max(t,e?Math.max.apply(null,e)-1:0)});var n=r(e);return t=t-t%n+(t%n>0&&n)};e.getMeasures=function(e){for(var t=[],n=1;n<=s(e)/r(e)+(c?1:0);n++)t.push(n);return t};var o=function(){return+new Date},u=t.$marker={measure:1,position:0,$bpm:90,bpm:function(e){return e&&(u.$bpm=e),u.$bpm},$start:o(),$playing:!1,play:function(e){e&&u.bpm(e),u.$playing=!0,u.$start=o()-(u.$paused||0),requestAnimationFrame(u.$refresh)},pause:function(){u.$playing=!1,u.$paused=o()-u.$start},stop:function(){u.$start=o()+1e3,u.$playing=!1,u.$paused=0},$refresh:function(){e.$apply(function(){var t=o()-u.$start,n=6e4/u.$bpm*r(e.beat);u.position=Math.min(Math.max(0,t%n/n),1);var a=e.getMeasures(e.beat,e.editing).length,i=Math.floor(t/n)+1;u.measure=i>a?(i+1)%a+1:i}),u.$playing&&requestAnimationFrame(u.$refresh)}};u.play(),e.progress=function(e,t){return(Math.abs(e)-1)%r(t)/r(t)},e.lyric=function(e,t){var n=(a(t),e-parseInt(e));return n>0&&.2525>=n?"e":n>=.33&&.505>=n?"&":n>=199/300?"a":(e-1)%t.beatsPerBar+1},e.addNote=function(t,n,a,i){t||(t={}),t.channels||(t.channels={}),t.channels[n]||(t.channels[n]=[]);var s=i+(a-1)*r(e.beat);return t.channels[n].push(s),console.log(t,n,a,i,s),s},e.alterNote=function(e,t){var n=e.indexOf(t);n>=0&&(e[n]=-e[n])},e.removeNote=function(e,t){e||(e=[]);var n=e.indexOf(t);n>=0&&e.splice(n,1)};var c=!1;e.editing=function(e){return void 0!==e&&(c=e),c},e.reset=function(){e.selectedBeat=0},e["delete"]=function(){e.beats.$inst().$remove(e.selectedBeat).then(e.reset)},e.save=function(){e.selectedBeat?e.beats.$inst().$update(e.selectedBeat,e.beat):e.beats.$inst().$push(e.beat).then(function(t){e.selectedBeat=t.key()})}}]).filter("filterNotesByMeasure",function(){return function(e,t,n){if(!e)return e;var r=(n-1)*t.beatsPerBar*t.barsPerLine,a=(n-0)*t.beatsPerBar*t.barsPerLine;return e.filter(function(e){return e>=r+1&&a+1>e})}}).directive("ngResize",["$window",function(e){return function(t,n,r){var a=function(a){t.$eval(r.ngResize,{$width:n[0].offsetWidth,$height:n[0].offsetHeight,$vw:e.innerWidth,$vh:e.innerHeight,$event:a})};angular.element(e).on("resize",a).on("load",a)}}]);